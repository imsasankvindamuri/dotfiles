#!/usr/bin/env python3
"""
Setup pyrightconfig.json for Poetry projects.
Usage: setup_pyright [project_directory]
"""

import subprocess
import json
import os
import sys
from pathlib import Path

def main():
    # Get project directory from command line or use current directory
    project_dir = Path(sys.argv[1]) if len(sys.argv) > 1 else Path.cwd()
    
    # Change to project directory
    os.chdir(project_dir)
    
    # Check if this is a Poetry project
    if not (project_dir / "pyproject.toml").exists():
        print(f"Error: {project_dir} doesn't contain a pyproject.toml file")
        sys.exit(1)
    
    # Get Poetry venv path
    try:
        result = subprocess.run(
            ['poetry', 'env', 'info', '--path'],
            capture_output=True,
            text=True,
            check=True
        )
        venv_path = Path(result.stdout.strip())
    except (subprocess.CalledProcessError, FileNotFoundError) as e:
        print("Error: Could not get Poetry environment info")
        print("Make sure poetry is installed and this is a Poetry project")
        sys.exit(1)
    
    if not venv_path.exists():
        print(f"Error: Virtual environment not found at {venv_path}")
        sys.exit(1)
    
    # Create pyrightconfig.json
    config = {
        "exclude": [
            "**/__pycache__",
            "**/.pytest_cache",
            ".venv",
            ".poetry*",
            "dist",
            "build",
            "*.egg-info"
        ],
        "venvPath": str(venv_path.parent),
        "venv": venv_path.name,
        "typeCheckingMode": "strict",
        "reportMissingImports": True,
        "useLibraryCodeForTypes": True,
        "reportMissingTypeStubs": "warning"
    }
    
    config_path = project_dir / "pyrightconfig.json"
    with open(config_path, 'w') as f:
        json.dump(config, f, indent=2)
    
    print(f"âœ“ Created {config_path}")
    print(f"  Virtual environment: {venv_path.name}")
    print(f"  Type checking mode: strict")

if __name__ == "__main__":
    main()
